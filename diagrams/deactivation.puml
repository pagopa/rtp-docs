@startuml

skin rose
participant "SP Debitore" as SPD
participant "Activation Service" as AS
participant "Auth Service" as AUTH
participant "Activation Repo" as AR
participant "Database" as DB

SPD -> AS: DELETE /activations/{activationId}
activate AS

AS -> AR: findPayerById
deactivate AS
activate AR

AR -> DB: findById
deactivate AR
activate DB

alt Activation not found
    DB --> AR: empty
    deactivate DB
    activate AR

    AR --> AS: empty
    deactivate AR
    activate AS

    AS --> SPD: 404 Not Found
    deactivate AS

else Activation found
    activate DB
    DB --> AR: ActivationEntity
    deactivate DB
    activate AR

    AR --> AS: Payer
    deactivate AR
    activate AS

    AS -> AUTH: verifySubjectRequest
    deactivate AS
    activate AUTH

    alt Access Denied
        AUTH --> AS: throws AccessDeniedException
        deactivate AUTH
        activate AS

        AS --> SPD: 404 Not Found
        deactivate AS

    else Access Granted
    activate AUTH
        AUTH --> AS: verified
        deactivate AUTH
        activate AS

        AS -> AR: deactivatePayer
        deactivate AS
        activate AR

        AR -> AR: toDeletedDbEntity
        AR -> DB: save
        deactivate AR
        activate DB

        DB --> AR: saved
        deactivate DB
        activate AR

        AR -> DB: deleteById
        deactivate AR
        activate DB

        DB -> AR: deleted
        deactivate DB
        activate AR

        AR --> AS: deleted
        deactivate AR
        activate AS

        AS --> SPD: 204 No Content
        deactivate AS
    end
end

@enduml
