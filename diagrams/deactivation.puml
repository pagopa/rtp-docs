@startuml
' PlantUML Diagram for RTP Deactivation API
' Title: Unified RTP Deactivation Sequence Diagram
' Version: 2.0.0
' Description: This diagram merges two sources to show the detailed process for a Payer's Service Provider
'              to deactivate the RTP service for an end-user, including internal logic and all error cases.

!theme materia

title RTP Deactivation API: DELETE /activations/{activationId}

actor "**Payer's Service Provider**" as PSP
participant "**Activation Service**" as AS
database "**Database**" as DB

autonumber "<b>[0]"

PSP -> AS: **DELETE** /activations/{activationId}
activate AS

note right of AS
  **Operation:** `deactivate`
  A Payer's SP calls this to remove an RTP registration.
end note

AS -> AS: Validate Request & Security Token
note right: Checks for a valid, non-expired JWT.

alt #palegreen **Success Case: Deactivation Complete**

    AS -> DB: Find activation by ID
    activate DB
    DB --> AS: Activation record found
    deactivate DB

    AS -> AS: Verify ownership (JWT subject vs. record)
    note right: Subject in token matches the Service Provider ID in the record. Access is granted.

    AS -> DB: Archive activation record
    activate DB
    note right of DB: Moves the record to a separate collection for audit purposes.
    DB --> AS: Archive successful
    deactivate DB

    AS -> DB: Delete activation record
    activate DB
    DB --> AS: Deletion successful
    deactivate DB

    AS --> PSP: **204 No Content**
    note left of PSP
        The deactivation was successful.
        The Payer can no longer receive RTPs.
    end note

else #lightyellow **Error: Not Found**

    AS -> DB: Find activation by ID
    activate DB
    DB --> AS: empty
    deactivate DB

    AS --> PSP: **404 Not Found**
    note left of PSP: The specified activation could not be found.

else #lightcoral **Error: Forbidden**

    AS -> DB: Find activation by ID
    activate DB
    DB --> AS: Activation record found
    deactivate DB

    AS -> AS: Verify ownership (JWT subject vs. record)
    note right: **Access Denied**: Subject in token does NOT match the owner.

    AS --> PSP: **403 Forbidden**
    note left of PSP: You do not have permission to delete this activation.

else #darkred **Other Errors**

    group Client-Side Errors
        AS --> PSP: **401 Unauthorized**\n(e.g., Invalid or expired security token)
        AS --> PSP: **429 Too Many Requests**\n(e.g., Rate limit exceeded)
    end group

    group Server-Side Error
        AS -> AS: An unexpected internal error occurs
        note right: e.g., Database connection failure, unhandled exception.
        AS --> PSP: **500 Internal Server Error**
    end group

end

deactivate AS

@enduml
