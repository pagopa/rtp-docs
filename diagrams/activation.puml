@startuml
' PlantUML Diagram for RTP Activation API
' Title: Unified RTP Activation Sequence Diagram with OTP Takeover
' Version: 2.1.0
' Description: This diagram shows the detailed process for activating a Payer.
'              If the Payer already exists, a takeover OTP is generated.

!theme materia

title RTP Activation API: POST /activations

actor "**Payer's Service Provider**" as PSP
participant "**Activation Service**" as AS
database "**Database**" as DB

autonumber "<b>[0]"

PSP -> AS: **POST** /activations\n(Activate RTP for a Payer)
activate AS

note right of AS
  **Operation:** `activate`
  A Payer's SP calls this to register a user for the RTP service.
end note

AS -> AS: Validate Request & Security Token

alt #palegreen **Success Case: New Payer Activation**

    AS -> AS: Create `Payer` object with a new `ActivationID` and current timestamp
    note right: As per `new Payer(...)`

    AS -> DB: `save(payer)`
    activate DB
    DB --> AS: Payer saved successfully
    deactivate DB

    AS -> AS: Log successful activation
    note right: As per `.doOnSuccess(...)`

    AS --> PSP: **201 Created**\nHeader: `Location: /activations/{newActivationId}`
    note left of PSP
        The activation was successful.
        The Payer can now receive RTPs.
    end note

else #lightyellow **Conflict: Payer Already Exists -> Generate OTP**

    AS -> AS: Create `Payer` object to attempt insertion

    AS -> DB: `save(payer)`
    activate DB
    DB --> AS: **Error:** `DuplicateKeyException`
    deactivate DB
    note right of AS: A unique key constraint on fiscalCode was violated.

    AS -> AS: Map `DuplicateKeyException` to `PayerAlreadyExists` error
    note right: As per `.onErrorResume(PayerAlreadyExists.class, ...)`

    AS -> AS: **Call `generateTakeOverOtp()`**
    note right
        The payer already exists.
        The service now initiates the takeover process.
    end note

    AS -> DB: Create and save `TakeOverOtp`
    activate DB
    DB --> AS: Return new `OTP`
    deactivate DB

    AS --> PSP: **409 Conflict**\nHeader: `Location: /takeover/{otp}`
    note left of PSP
        An activation for this Payer already exists.
        The `Location` header points to the takeover URI with the generated OTP.
    end note

else #darkred **Other Errors**

    group Client-Side Errors
        AS --> PSP: **400 Bad Request**\n(e.g., Invalid fiscal code, missing fields)
        AS --> PSP: **401 Unauthorized**\n(e.g., Invalid or expired security token)
        AS --> PSP: **403 Forbidden**\n(e.g., Insufficient permissions)
        AS --> PSP: **429 Too Many Requests**\n(e.g., Rate limit exceeded)
    end group

    group Server-Side Error
        AS -> AS: An unexpected internal error occurs
        note right: e.g., Database connection failure, unhandled exception.
        AS --> PSP: **500 Internal Server Error**
    end group

end

deactivate AS
@enduml